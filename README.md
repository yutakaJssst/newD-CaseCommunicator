# GSN Editor

Goal Structuring Notation (GSN) を描画・編集するためのWebアプリケーション。

## プロジェクト概要

既存の **D-Case Communicator** をスクラッチで作り直すプロジェクト。
基本的なGSN描画機能とモジュール階層管理機能を実装しています。

### 現在の実装状態

**Phase 1 (MVP)**: ✅ 完了
**Phase 2**: ✅ 完了
**Phase 3 (Diagram DB Storage)**: ✅ 完了 (2025-12-17)
**Phase 4 (Multiuser Sharing)**: ✅ 完了 (2025-12-17)
**Phase 5 (Real-time Collaboration)**: ✅ 完了 (2025-12-17)
**モジュール機能**: ✅ 完了
**プロジェクトエクスポート/インポート**: ✅ 完了

## 技術スタック

### フロントエンド
- **フレームワーク**: React 19.2.0
- **言語**: TypeScript 5.9.3
- **状態管理**: Zustand 5.0.9
- **ビルドツール**: Vite 7.2.4
- **描画**: SVG (ネイティブ)
- **パッケージマネージャ**: npm

### バックエンド
- **フレームワーク**: Express.js 4.21.2
- **言語**: TypeScript 5.7.3
- **データベース**: SQLite (開発環境) / Prisma ORM
- **ORM**: Prisma 6.2.1
- **認証**: JWT (jsonwebtoken 9.0.2)
- **リアルタイム通信**: Socket.IO v4
- **ランタイム**: Node.js 20.17.0

## 主要機能

### 実装済み

#### 基本機能
- ✅ **GSN要素（8種類のノード）の描画**
  - Goal, Strategy, Context, Evidence, Assumption, Justification, Undeveloped, Module
- ✅ **ノード間の接続（リンク）の描画**
  - GSN標準準拠: Context/Assumption/Justificationへのリンクは白抜き矢印
  - スマート接続点計算: 横並び・縦並びに応じた最適な接続
- ✅ **ノードの配置・移動**
  - ドラッグ&ドロップ
  - 複数選択（Ctrl+クリック）による一括移動
- ✅ **ノードのサイズ変更**
  - 4方向リサイズハンドル
- ✅ **キャンバス操作**
  - ズーム（Ctrl/Cmd + ホイール、範囲: 0.2〜3.0倍）
  - パン（中ボタンドラッグ / Shift+左ドラッグ / 空白領域ドラッグ）
- ✅ **ノード内容の編集**
  - リッチテキストエディタ（太字、斜体、下線、フォントサイズ、URLリンク対応）
- ✅ **エクスポート/インポート**
  - JSON（現在のダイアグラム）
  - **プロジェクト全体（全モジュール含む）**
  - PNG画像（高解像度2倍）
  - SVG画像（ベクター形式）
- ✅ **右クリックメニュー**
  - リンク追加、ノード削除、モジュール変換
- ✅ **Undo/Redo**
  - 履歴管理（最大50件）
  - キーボードショートカット（Ctrl+Z / Ctrl+Y）
- ✅ **グリッドスナップ**
  - 20px間隔グリッド、ON/OFF切り替え
- ✅ **ノードラベル自動採番**
  - G1, S1, E1などノードタイプごとに自動採番
- ✅ **LocalStorage自動保存**
  - ページを閉じても作業内容が保持される

#### モジュール機能
- ✅ **Moduleノードタイプ**
  - フォルダ型アイコン、別ダイアグラムへのリンク
- ✅ **Goalからのモジュール化**
  - 右クリックメニュー「モジュールにする」でサブツリーを別ダイアグラムに分離
- ✅ **空のモジュール作成**
  - サイドバーから直接Moduleノードを配置可能
- ✅ **モジュール階層管理**
  - ネストしたモジュール構造をサポート
- ✅ **モジュールナビゲーション**
  - ダブルクリックでモジュール内を開く
  - パンくずリストで親階層に戻る
  - 右クリックメニュー「親モジュールを開く」
- ✅ **トップゴール自動反映**
  - モジュール内のルートGoalの内容が親ダイアグラムのModuleノードに表示
- ✅ **プロジェクト全体のエクスポート/インポート**
  - 全モジュールとラベル番号を含む完全なプロジェクトデータの保存・復元
  - 自動判定機能（プロジェクトデータか単一ダイアグラムかを自動認識）

#### データベース連携機能（Phase 3）
- ✅ **ユーザー認証**
  - ログイン/ログアウト/新規登録
  - JWT認証
- ✅ **プロジェクト管理**
  - プロジェクト作成・読み込み・更新・削除
  - プロジェクト一覧表示
- ✅ **ダイアグラム管理**
  - ダイアグラムのDB保存・読み込み
  - プロジェクトごとのダイアグラム管理

#### マルチユーザー共有機能（Phase 4）
- ✅ **プロジェクトメンバー管理**
  - メンバー招待（メールアドレス指定）
  - メンバー一覧表示
  - ロール管理（owner/editor/viewer）
  - メンバー削除
- ✅ **権限ベースUI**
  - オーナーのみ編集可能な操作を制限
  - メンバーは読み取り専用表示
- ✅ **アクティビティログ**
  - メンバー操作の記録（招待、ロール変更、削除）

#### リアルタイム同時編集機能（Phase 5）
- ✅ **WebSocket通信（Socket.IO）**
  - プロジェクトごとのルーム管理
  - 自動再接続機能
- ✅ **リアルタイム同期**
  - ノード追加/更新/削除の即座反映
  - **ノード移動のリアルタイム同期**（ドラッグ操作）
  - **複数ノード移動の同期**（矢印キー、一括ドラッグ）
  - リンク作成/削除の即座反映
- ✅ **オンラインユーザー表示**
  - ヘッダーに緑色インジケーター表示
  - 「○人オンライン」とユーザー名リスト
  - ユーザー参加/離脱の通知
- ✅ **競合解決**
  - Last-Write-Wins方式（最後の書き込みが優先）

### 未実装（今後の予定）

- ❌ ユーザーカーソル表示（他のユーザーのマウスカーソル位置）
- ❌ CRDT（高度な競合解決）
- ❌ メール通知機能（メンバー招待時のメール送信）
- ❌ テンプレート機能
- ❌ 検証機能（ルートノード存在チェック、循環参照検出、孤立ノード警告）

## セットアップ

### バックエンド

```bash
cd backend

# 依存関係をインストール
npm install

# 環境変数を設定
cp .env.example .env
# .envファイルを編集してJWT_SECRETを設定

# Prismaマイグレーション実行
npx prisma migrate dev

# 開発サーバー起動
npm run dev
```

バックエンドサーバーは http://localhost:3001 で起動します（HTTP + WebSocket）。

### フロントエンド

```bash
# リポジトリをクローン
git clone <repository-url>
cd newD-CaseCommunicator/gsn-editor

# 依存関係をインストール
npm install

# 開発サーバー起動
npm run dev
```

開発サーバーは http://localhost:5173/ で起動します。

## ビルド

```bash
# プロダクションビルド
npm run build

# ビルド結果をプレビュー
npm run preview
```

## 使い方

### ログインと認証

1. 初回はアカウント登録が必要です
2. メールアドレスとパスワードでログイン
3. ログイン後、プロジェクト一覧画面が表示されます

### プロジェクト管理

1. **新規プロジェクト作成**:
   - 「＋ 新規プロジェクト」ボタンをクリック
   - プロジェクト名と説明を入力
   - 「作成」ボタンで作成

2. **プロジェクトを開く**:
   - プロジェクトカードをクリック

3. **メンバー管理**:
   - プロジェクトカードの「メンバー」ボタンをクリック
   - オーナーのみメンバー招待・ロール変更・削除が可能
   - メンバーの役割:
     - **Owner（オーナー）**: 全ての操作が可能
     - **Editor（編集者）**: ダイアグラムの編集が可能
     - **Viewer（閲覧者）**: 閲覧のみ可能

### ノードの追加

1. 左サイドバーからノードタイプを選択
2. キャンバスをクリックして配置

### リンクの作成

1. 親ノードを右クリック
2. 「子ノードにリンク」を選択
3. 子ノードをクリック

### ノードの編集

- ノードをダブルクリックで編集モーダルを表示
- リッチテキストエディタで太字、斜体、下線、フォントサイズ、URLリンクを設定可能

### ノードのサイズ変更

- ノードを選択すると4隅にリサイズハンドル（小さな正方形）が表示
- ハンドルをドラッグしてサイズ変更

### 複数選択

- Ctrl+クリックで複数ノード選択
- 選択したノードを一括でドラッグ移動可能

### キャンバス操作

- **ズーム**: Ctrl/Cmd + マウスホイール、またはヘッダーの +/- ボタン
- **パン**: 中ボタンドラッグ / Shift+左ドラッグ / 空白領域ドラッグ
- **グリッドスナップ**: ヘッダーの ⊞ ボタンでON/OFF切り替え
- **選択解除**: 空白領域をクリック

### モジュール機能の使い方

#### モジュールの作成
1. **Goalからモジュール化**:
   - Goalノードを右クリック
   - 「モジュールにする」を選択
   - サブツリー全体が別ダイアグラムに分離され、Moduleノードに置き換わる

2. **空のモジュール作成**:
   - サイドバーから「Module」を選択
   - キャンバスをクリックして配置

#### モジュール間の移動
- **モジュール内を開く**: Moduleノードをダブルクリック
- **親に戻る**:
  - パンくずリストの親階層をクリック
  - トップゴールを右クリック → 「親モジュールを開く」

#### プロジェクト全体の保存・読み込み
1. **エクスポート**:
   - ヘッダーの「エクスポート ▾」をクリック
   - 「プロジェクト全体（全モジュール）」を選択
   - `{タイトル}-project.json` ファイルがダウンロードされる

2. **インポート**:
   - ヘッダーの「インポート」ボタンをクリック
   - プロジェクトJSONファイルを選択
   - 確認ダイアログで「OK」をクリック
   - 全モジュールとラベル番号が復元される

### データの保存・読み込み

- **エクスポート**:
  - JSON（現在のダイアグラムのみ）
  - プロジェクト全体（全モジュール含む）※推奨
  - PNG画像（高解像度2倍）
  - SVG画像（ベクター形式）

- **インポート**:
  - ファイル形式を自動判定（プロジェクトデータか単一ダイアグラムか）
  - プロジェクトデータの場合は確認ダイアログを表示

### リアルタイム同時編集のテスト

複数ユーザーでのリアルタイム編集をテストする方法：

1. **2つのブラウザウィンドウを開く**:
   - ブラウザ1: http://localhost:5173
   - ブラウザ2: http://localhost:5174
   - または、別のブラウザ/シークレットモードを使用

2. **異なるユーザーでログイン**:
   - 各ブラウザで異なるアカウントでログイン
   - または新規登録して別ユーザーを作成

3. **同じプロジェクトを開く**:
   - 両方のブラウザで同じプロジェクトを選択

4. **リアルタイム同期を確認**:
   - ヘッダー右側に「2人オンライン」と緑色インジケーター表示
   - 片方でノードをドラッグ → もう片方でリアルタイム移動
   - ノード追加/削除/リンク作成 → 即座に同期
   - オンラインユーザー名が表示される

## GSN標準への準拠

### ノードタイプ

| タイプ | 形状 | デフォルト色 | 用途 |
|--------|------|--------------|------|
| Goal | 矩形 | 白 (#FFFFFF) | 達成すべき目標 |
| Strategy | 平行四辺形 | 白 (#FFFFFF) | ゴール分解の方針 |
| Context | 角丸矩形 | 白 (#FFFFFF) | 前提条件 |
| Evidence | 楕円 | 白 (#FFFFFF) | ゴール達成の根拠 |
| Assumption | 楕円 | 白 (#FFFFFF) | 論証の仮定事項 |
| Justification | 楕円 | 白 (#FFFFFF) | 戦略の正当性根拠 |
| Undeveloped | ダイヤモンド | 白 (#FFFFFF) | 未展開のゴール |
| Module | フォルダ型 | グレー (#E0E0E0) | 別ダイアグラムへのリンク |

### リンクの種類

- **SupportedBy（サポート関係）**: 塗りつぶし矢印 + 実線
  - Goal/Strategy/Evidence/Undeveloped/Moduleノードへのリンク
  - 縦方向の接続（親の下端 → 子の上端）
- **InContextOf（文脈関係）**: 白抜き矢印 + 実線
  - Context/Assumption/Justificationノードへのリンク
  - 横方向の接続（親の左右 → 子の左右）
  - 自動的に白抜き矢印が適用される

## プロジェクト構成

```
gsn-editor/
├── src/
│   ├── App.tsx                    # メインアプリケーション
│   ├── main.tsx                   # エントリーポイント
│   ├── components/
│   │   ├── Canvas/
│   │   │   ├── Canvas.tsx         # SVGキャンバス
│   │   │   ├── Node.tsx           # ノード描画
│   │   │   ├── Link.tsx           # リンク描画（GSN標準準拠）
│   │   │   ├── NodeEditor.tsx    # リッチテキストエディタ
│   │   │   └── ContextMenu.tsx   # 右クリックメニュー
│   │   ├── Header/
│   │   │   └── Header.tsx         # ヘッダー（エクスポート/インポート、Undo/Redo）
│   │   └── Sidebar/
│   │       ├── Sidebar.tsx        # サイドバー
│   │       └── NodePalette.tsx   # ノードパレット
│   ├── stores/
│   │   └── diagramStore.ts        # Zustand状態管理
│   ├── types/
│   │   └── diagram.ts             # TypeScript型定義
│   └── utils/
├── public/
└── index.html
```

## 開発ガイド

詳細な開発ガイドは [CLAUDE.md](./CLAUDE.md) を参照してください。

## 参考資料

- [GSN Community Standard Version 3.0 (2021)](https://scsc.uk/gsn)
- 既存D-Case Communicator実装（`dcase_com-main/` ディレクトリ）

## ライセンス

(ライセンス情報を記載)

## 更新履歴

### 2025-12-17

- ✅ **Phase 3: Diagram DB Storage 完了**
  - バックエンドAPI実装（Express + TypeScript + Prisma）
  - ユーザー認証（JWT）
  - プロジェクト管理（CRUD操作）
  - ダイアグラムのDB保存・読み込み
  - SQLiteデータベース統合
- ✅ **Phase 4: Multiuser Sharing 完了**
  - プロジェクトメンバー管理UI
  - メンバー招待機能（メールアドレス指定）
  - ロール管理（owner/editor/viewer）
  - メンバー削除機能
  - 権限ベースUI制御
  - アクティビティログ記録
- ✅ **Phase 5: Real-time Collaboration 完了**
  - WebSocket通信実装（Socket.IO v4）
  - ノード移動のリアルタイム同期
  - 複数ノード移動の同期（矢印キー、一括ドラッグ）
  - オンラインユーザー表示UI
  - プロジェクトごとのルーム管理
  - 自動再接続機能
  - Last-Write-Wins競合解決

### 2025-12-16

- ✅ **モジュール機能完全実装**
  - Moduleノードタイプの追加
  - Goalからのモジュール化
  - モジュール階層管理・ナビゲーション
  - パンくずリスト
  - トップゴール自動反映
- ✅ **プロジェクト全体エクスポート/インポート機能**
  - 全モジュールとラベル番号を含む完全なプロジェクトデータの保存・復元
  - ファイル形式自動判定
- ✅ **UX改善**
  - ノードラベル自動採番（G1, S1, E1など）
  - グリッドスナップ機能
  - リンク右クリック削除
  - PNG/SVGエクスポート
- ✅ **Undo/Redo機能**
  - 履歴管理（最大50件）
  - キーボードショートカット（Ctrl+Z / Ctrl+Y）
- ✅ **複数選択機能**
  - Ctrl+クリックで複数選択
  - 一括ドラッグ移動
- ✅ **リッチテキストエディタ**
  - 太字、斜体、下線、フォントサイズ、URLリンク対応
- ✅ **LocalStorage自動保存**
  - ページを閉じても作業内容が保持される

### 2025-12-09

- ✅ Phase 1 (MVP) 完了
- ✅ ノードサイズ変更機能実装（Phase 2）
- ✅ GSN標準準拠のリンク描画実装（Phase 2）
  - Context/Assumption/Justificationへのリンクは白抜き矢印
  - 相対位置に基づく最適な接続点計算
